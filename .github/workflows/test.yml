name: Run Tests

on: [push]

jobs:
  build:

    runs-on: ${{ matrix.config.os }}
    strategy:
      matrix:
        config:
          - {os: ubuntu-latest, python: 3.7, ffmpeg: "4.1"}
          - {os: ubuntu-latest, python: 3.7, ffmpeg: "4.0"}
          - {os: ubuntu-latest, python: 2.7, ffmpeg: "4.1"}
          - {os: ubuntu-latest, python: 2.7, ffmpeg: "4.0"}
          - {os: macos-latest,  python: 2.7, ffmpeg: "4.1"}

    steps:

    - uses: actions/checkout@v1
      with:
          fetch-depth: 1

    - name: Set up Python ${{ matrix.config.python }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.config.python }}

    - name: OS dependencies
      run: |
        case ${{ matrix.config.os }} in
          ubuntu-latest)
            sudo apt-get update
            sudo apt-get install autoconf automake build-essential cmake \
              libtool mercurial pkg-config texinfo wget yasm zlib1g-dev
            sudo apt-get install libass-dev libfreetype6-dev libjpeg-dev \
              libtheora-dev libvorbis-dev libx264-dev
            ;;
          macos-latest)
            brew update
            brew install automake libtool nasm pkg-config shtool texi2html wget
            brew install libass libjpeg libpng libvorbis libvpx opus theora x264
            ;;
        esac

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install virtualenv
        . scripts/activate.sh ffmpeg-${{ matrix.config.ffmpeg }}
        scripts/build-deps

    - name: Build
      run: |
        . scripts/activate.sh ffmpeg-${{ matrix.config.ffmpeg }}
        scripts/build

    - name: Test
      run: |
        . scripts/activate.sh ffmpeg-${{ matrix.config.ffmpeg }}
        scripts/test


